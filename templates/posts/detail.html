{% extends 'base.html' %}
{% load static cache humanize main_tags %}

{% block content %}

<div class="row bg-white">
    <div class="post-content col-md-9 mt-4">
        <div class="card">
            <div class="row">
                <div class="col-md-3">
                    {% if post.image %}
                        <img src="{{ post.image.url }}" class="img-thumbnail" data-bs-toggle="modal"
                            data-bs-target="#imageModal1">
                    {% else %}
                        <img src="{% static 'images/not_found_image.png' %}" class="img-thumbnail">
                    {% endif %}
                </div>
                
                <div class="col-md-7">
                    <h2 class="mt-3">{{ post.title }}</h2>
                    <p class="mt-3">
                        Автор: 
                        {% if post.user %}
                            <a href="{% url 'user:detail' post.user.username %}">
                                <b>{{ post.user.get_full_name }}</b></a>
                        {% else %}
                            [невідомий]
                        {% endif %}
                        
                        <a href="{% url 'posts:type' post.type.slug %}"
                            class="font-weight-bold ml-2"
                            style="color: {{ post.type.color }}">
                            {{ post.type }}
                        </a>
                        
                        <a href="#comments" class="text-dark float-right">
                            <i class="bi bi-chat-right-text"></i> 
                            {{ post.comment_count }}
                        </a>  
                    </p>
                    <p class="text-secondary">
                        {{ post.created_date }}
                        {% if user.is_staff %}
                            <a href="{% url 'posts:delete' post.slug %}" 
                                class="btn btn-danger float-right"
                                onclick="return confirm('Ви впевнені, що хочете видалити цю публікацію?');">
                                <i class="bi bi-trash"></i>
                            </a>
                            <a href="{% url 'admin:posts_post_change' post.id %}" 
                                class="btn btn-dark float-right">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                        {% endif %}
                    </p>
                </div>
            </div>
    
            <div class="ck-content">
                {{ post.content|safe }}
            </div>
            
            <div class="post-tags m-2 p-2 bg-light">
                <i>
                    <p class="d-inline fst-italic">
                        Рубрики: |
                        {% for topic in post.topics.all %}
                            <a href="{% url 'posts:topic' topic.slug %}"    
                                title="
                                {% if topic.description %}
                                    {{ topic.description }}
                                {% else %}
                                    {{ topic.name }}
                                {% endif %}
                                    ">{{ topic }}</a>
                                    |
                        {% endfor %}
                    </p>
                    <p>
                        Теги:
                        {% for tag in post.tags.all %}
                            <a href="{% url 'posts:tag' tag.slug %}"    
                                title="
                                {% if tag.description %}
                                    {{ tag.description }}
                                {% else %}
                                    {{ tag.name }}
                                {% endif %} 
                                    "> {{ tag }}</a>, 
                        {% endfor %}
                    </p>
                </i>
            </div>

            <div class="post-buttons m-2">
                <text class="post-likes mr-3" title="Подобається"
                    hx-get="/api/post-like/{{ post.pk }}" 
                    hx-trigger="click"
                    hx-target=".post-likes">
                    {% csrf_token %}
                    ➕ {{ post.likes.count }}
                </text>
                <text class="post-dislikes mr-3" title="Не подобається"
                    hx-get="/api/post-dislike/{{ post.pk }}" 
                    hx-trigger="click"
                    hx-target=".post-dislikes">
                    {% csrf_token %}
                    ➖ {{ post.dislikes.count }}
                </text>
                <text class="post-saves btn btn-dark" title="В закладки"
                    hx-get="/api/post-save/{{ post.pk }}" 
                    hx-trigger="click"
                    hx-target=".post-saves">
                    {% csrf_token %}
                    <i class="bi bi-bookmark"></i> {{ post.saves.count }}
                </text>
                <i class="bi bi-bookmark-check-fill"></i>
            </div>
        </div>
    </div>
    {% with post_list=latest_posts %}
        <div class="latest_posts col-md-3 mt-4">
            <h4>Останні {{ post.type.name|lower }}</h4>
            {% include 'posts/_other_post_list.html' %}
        </div>
    {% endwith %}
</div>

<div class="post-comments">
    <div class="row bg-white mt-3 overflow-hidden flex-md-row shadow-sm h-md-250 position-relative">
        <div class="col d-flex flex-column position-static">
            <h4 id="comments" class="pt-3">Коментарі ({{ post.comment_count }}):</h4>
            <form class="mb-3" method="post" action="{% url 'posts:detail' post.slug %}">
                {% csrf_token %}
                <input id="post_id" name="post_id" value="{{ post.id }}" required hidden>
                <div class="form-group pt-3">
                    <textarea class="form-control" 
                        id="comment_text" 
                        name="comment_text" 
                        rows="2" 
                        placeholder="Напишіть коментар..."
                        required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Надіслати</button>
            </form>
        </div>
    </div>

    {% if post.comments %}
        {% include 'posts/_comment_tree.html' with comments=post.comments %}
    {% endif %}
</div>

{% with modal_image=post.image modal_title=post.title %}
    {% include '_modal_image_preview.html' %}
{% endwith %}

{% endblock %}
